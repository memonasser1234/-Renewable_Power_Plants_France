import pandas as pd
import numpy as np

# 1. Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù
input_file = 'renewable_power_planets_FR_filtered.xlsx'
df = pd.read_excel(input_file)
print(f"âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {df.shape[0]} ØµÙ Ã— {df.shape[1]} Ø¹Ù…ÙˆØ¯")

# 2. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª
# ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
df['capacity'] = pd.to_numeric(df['capacity'], errors='coerce')
df['lon'] = pd.to_numeric(df['lon'], errors='coerce')
df['lat'] = pd.to_numeric(df['lat'], errors='coerce')

# ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
for col in ['commissioning_date', 'connection_date', 'disconnection_date']:
    if col in df.columns:
        df[col] = pd.to_datetime(df[col], errors='coerce')

# ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†ØµÙˆØµ
text_columns = ['energy_source_level_1', 'energy_source_level_2', 
                'technology', 'region', 'site_name', 'departement']
for col in text_columns:
    if col in df.columns:
        df[col] = df[col].astype(str).str.strip()

# 3. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
# Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙÙˆÙ Ø§Ù„ØªÙŠ ØªÙØªÙ‚Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©
essential_cols = ['capacity', 'energy_source_level_1']
df = df.dropna(subset=essential_cols, how='all')

# Ù…Ù„Ø¡ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù†ØµÙŠØ© Ø§Ù„Ù…Ù‡Ù…Ø©
for col in ['energy_source_level_2', 'technology', 'region']:
    if col in df.columns:
        df[col] = df[col].replace(['nan', 'None', ''], 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')
        df[col] = df[col].fillna('ØºÙŠØ± Ù…Ø­Ø¯Ø¯')

# 4. Ø¥Ø¶Ø§ÙØ© Ø£Ø¹Ù…Ø¯Ø© Ù…ÙÙŠØ¯Ø©
# Ø³Ù†Ø© Ø§Ù„ØªØ£Ø³ÙŠØ³
if 'commissioning_date' in df.columns:
    df['commissioning_year'] = df['commissioning_date'].dt.year

# 5. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª
df = df.drop_duplicates()

# 6. Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¸ÙØ© Ø¨Ù†ÙØ³ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
output_excel = 'renewable_power_planets_FR_filtered_cleaned.xlsx'
output_csv = 'renewable_power_planets_FR_filtered_cleaned.csv'

df.to_excel(output_excel, index=False, encoding='utf-8-sig')
df.to_csv(output_csv, index=False, encoding='utf-8-sig')

print(f"âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ:")
print(f"   - {output_excel}")
print(f"   - {output_csv}")

# 7. Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹
print("\nğŸ“Š Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¸ÙØ©:")
print(f"Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: {df.shape[0]}")
print(f"Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: {df.shape[1]}")
print(f"\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø¯Ø±Ø©: {df['capacity'].sum():.2f} MW")
print(f"Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©: {df['site_name'].nunique()}")

if 'energy_source_level_2' in df.columns:
    print("\nØªÙˆØ²ÙŠØ¹ Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø·Ø§Ù‚Ø©:")
    print(df['energy_source_level_2'].value_counts())

if 'region' in df.columns:
    print("\nØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ø£Ø¹Ù„Ù‰ 5):")
    print(df['region'].value_counts().head(5))

# 8. Ø¹Ø±Ø¶ Ø¹ÙŠÙ†Ø©
print("\nğŸ” Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (3 ØµÙÙˆÙ Ø£ÙˆÙ„Ù‰):")
print(df.head(3))

# 9. Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
print("\nğŸ“ˆ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:")
print(f"Ø£Ù‚Ø¯Ù… ØªØ§Ø±ÙŠØ® Ø¥Ù†Ø´Ø§Ø¡: {df['commissioning_date'].min().year if 'commissioning_date' in df.columns else 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}")
print(f"Ø£Ø­Ø¯Ø« ØªØ§Ø±ÙŠØ® Ø¥Ù†Ø´Ø§Ø¡: {df['commissioning_date'].max().year if 'commissioning_date' in df.columns else 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}")
print(f"Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø¯Ø±Ø©: {df['capacity'].mean():.2f} MW")
print(f"Ø£ÙƒØ¨Ø± Ù…Ø­Ø·Ø©: {df['capacity'].max():.2f} MW")

# 10. Ø­ÙØ¸ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ Ù…Ù„Ù Ù†ØµÙŠ
stats_file = 'renewable_power_planets_FR_filtered_stats.txt'
with open(stats_file, 'w', encoding='utf-8') as f:
    f.write("="*50 + "\n")
    f.write("Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø·Ø§Øª Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ØªØ¬Ø¯Ø¯Ø© - ÙØ±Ù†Ø³Ø§\n")
    f.write("="*50 + "\n\n")
    f.write(f"Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: {df.shape[0]}\n")
    f.write(f"Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: {df.shape[1]}\n")
    f.write(f"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø¯Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: {df['capacity'].sum():.2f} MW\n")
    f.write(f"Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©: {df['site_name'].nunique()}\n")
    f.write(f"Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø¯Ø±Ø© Ù„ÙƒÙ„ Ù…Ø­Ø·Ø©: {df['capacity'].mean():.2f} MW\n\n")
    
    if 'energy_source_level_2' in df.columns:
        f.write("ØªÙˆØ²ÙŠØ¹ Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø·Ø§Ù‚Ø©:\n")
        for source, count in df['energy_source_level_2'].value_counts().items():
            f.write(f"  - {source}: {count} Ù…Ø­Ø·Ø©\n")

print(f"\nğŸ“„ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ: {stats_file}")